<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>High Authority Dashboard - CivicSense</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --danger: #e74c3c;
      --danger-dark: #c0392b;
      --warning: #f59e0b;
      --success: #10b981;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #94a3b8;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 8px;
    }

    body {
      background-color: #f1f5f9;
      color: var(--dark);
      line-height: 1.6;
    }

    header {
      background-color: white;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo img {
      height: 40px;
      width: auto;
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 2rem;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--secondary);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      transition: all 0.3s ease;
    }

    .nav-links a:hover, .nav-links a.active {
      background-color: var(--primary);
      color: white;
    }

    .btn-login {
      background-color: var(--primary);
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: var(--radius);
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .btn-login:hover {
      background-color: var(--primary-dark);
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .authority-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background-color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      border-top: 4px solid;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card.red {
      border-color: var(--danger);
    }

    .stat-card.yellow {
      border-color: var(--warning);
    }

    .stat-card.green {
      border-color: var(--success);
    }

    .stat-card.blue {
      border-color: var(--info);
    }

    .stat-card h3 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-card p {
      color: var(--secondary);
      font-weight: 500;
    }

    .complaint-table-section {
      background-color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .complaint-table-section h2 {
      margin-bottom: 1.5rem;
      color: var(--dark);
      font-weight: 600;
    }

    .complaint-table {
      width: 100%;
      border-collapse: collapse;
    }

    .complaint-table th {
      background-color: #f8fafc;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 1px solid #e2e8f0;
    }

    .complaint-table td {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .complaint-table tr:hover {
      background-color: #f8fafc;
    }

    .status {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }

    .status.pending {
      background-color: #fef3c7;
      color: #92400e;
    }

    .status.in-progress {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .status.resolved {
      background-color: #d1fae5;
      color: #065f46;
    }

    .status.escalated {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .btn-escalate {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .btn-escalate:hover {
      background-color: var(--primary-dark);
    }

    .btn-escalate.disabled {
      background-color: var(--gray);
      cursor: not-allowed;
    }

    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background-color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .chart-card h3 {
      margin-bottom: 1rem;
      color: var(--dark);
      font-weight: 600;
    }

    .ai-insights {
      background-color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .ai-insights h2 {
      margin-bottom: 1rem;
      color: var(--dark);
      font-weight: 600;
    }

    .ai-insights ul {
      list-style: none;
    }

    .ai-insights li {
      padding: 0.75rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .ai-insights li:last-child {
      border-bottom: none;
    }

    .ai-insights b {
      color: var(--primary);
    }

    .footer {
      background-color: var(--dark);
      color: white;
      padding: 2rem 0;
      margin-top: 3rem;
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .footer-logo {
      height: 40px;
      width: auto;
    }

    .footer p {
      color: #cbd5e1;
      text-align: right;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }

    .btn-delete:hover {
      background: var(--danger-dark);
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 1024px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }

      .nav-links {
        gap: 1rem;
      }

      .dashboard-container {
        padding: 0 1rem;
      }

      .complaint-table {
        display: block;
        overflow-x: auto;
      }

      .footer-content {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .footer p {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- üåê Navbar -->
  <header>
    <nav class="navbar">
      <div class="logo">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="40" height="40" rx="8" fill="#2563eb"/>
          <path d="M12 20L16 24L28 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1>CivicSense</h1>
      </div>

      <ul class="nav-links">
        <li><a href="#overview" class="active">Overview</a></li>
        <li><a href="#departments">Departments</a></li>
        <li><a href="#ai">AI Insights</a></li>
        <li><a href="#reports">Reports</a></li>
      </ul>

      <div class="user-info">
        <span id="user-email" style="margin-right: 1rem; color: var(--secondary);"></span>
        <a href="#" class="btn-login" id="logout-btn">Logout</a>
      </div>
    </nav>
  </header>

  <!-- Dashboard Content -->
  <div class="dashboard-container">
    <!-- KPI Section -->
    <section class="authority-stats">
      <div class="stat-card red">
        <h3 id="escalated-count">0</h3>
        <p>Escalated Issues</p>
      </div>
      <div class="stat-card yellow">
        <h3 id="avg-response-time">0 hrs</h3>
        <p>Avg. Response Time</p>
      </div>
      <div class="stat-card green">
        <h3 id="resolved-today">0</h3>
        <p>Resolved Today</p>
      </div>
      <div class="stat-card blue">
        <h3 id="active-wards">0</h3>
        <p>Active Wards</p>
      </div>
    </section>

    <!-- Complaint Table -->
    <section id="overview" class="complaint-table-section">
      <h2>Escalated Complaints</h2>
      <div id="complaints-list" class="loading">
        <div class="spinner"></div>
      </div>
    </section>

    <!-- Charts Section -->
    <section id="departments" class="charts-container">
      <div class="chart-card">
        <h3>Complaints by Department</h3>
        <canvas id="deptChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Resolution Rate</h3>
        <canvas id="priorityChart"></canvas>
      </div>
    </section>

    <!-- AI Insights -->
    <section id="ai" class="ai-insights">
      <h2>AI Insights</h2>
      <ul>
        <li>‚ö† Garbage overflow increased by <b>25%</b> in Zone 3.</li>
        <li>‚è≥ Streetlight repairs delayed in <b>Zone 4</b>.</li>
        <li>üìà Predicted surge in water complaints due to pipeline aging.</li>
      </ul>
    </section>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="40" height="40" rx="8" fill="#2563eb"/>
        <path d="M12 20L16 24L28 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <p>¬© 2025 CivicSense | Empowering Smart Governance</p>
        <p>Developed during Smart City Hackathon</p>
      </div>
    </div>
  </footer>

  <!-- Firebase and Dashboard Logic -->
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA5mUr6bSmy6Yh9kyD1K1IDC6BNRVI-U6o",
      authDomain: "civicissuetrackerapp.firebaseapp.com",
      projectId: "civicissuetrackerapp",
      storageBucket: "civicissuetrackerapp.appspot.com",
      messagingSenderId: "52255435185",
      appId: "1:52255435185:web:68cfef81c27b42ae71b590"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    const complaintsList = document.getElementById("complaints-list");
    const logoutBtn = document.getElementById("logout-btn");
    const userEmail = document.getElementById("user-email");
    const escalatedCount = document.getElementById("escalated-count");
    const avgResponseTime = document.getElementById("avg-response-time");
    const resolvedToday = document.getElementById("resolved-today");
    const activeWards = document.getElementById("active-wards");

    // High Authority UID
    const HIGH_AUTHORITY_UID = "h2gi9IuaJyTvzjSg4moFJDdfpXv2";

    // Check authentication and redirect if not high authority
    auth.onAuthStateChanged(user => {
      if (!user) {
        // No user signed in, redirect to login
        window.location.href = "index.html";
      } else if (user.uid !== HIGH_AUTHORITY_UID) {
        // User is not high authority, redirect to appropriate dashboard
        if (user.uid === "OfHleQwQjgMRXTgroiAxJCJu5Sd2") {
          window.location.href = "admin-dashboard.html";
        } else {
          window.location.href = "citizen-dashboard.html";
        }
      } else {
        // User is high authority, load dashboard
        userEmail.textContent = user.email;
        loadComplaints();
        loadKPIs();
      }
    });

    // Load complaints
    function loadComplaints() {
      // First, check for complaints that need to be escalated
      checkForEscalations();
      
      // Then load all escalated complaints
      db.collection("complaints")
        .where("status", "in", ["Escalated", "Pending", "In Progress"])
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          complaintsList.innerHTML = "";
          
          if (snapshot.empty) {
            complaintsList.innerHTML = '<p>No escalated complaints found.</p>';
            return;
          }
          
          const table = document.createElement("table");
          table.className = "complaint-table";
          
          // Create table header
          const thead = document.createElement("thead");
          thead.innerHTML = `
            <tr>
              <th>Complaint</th>
              <th>Category</th>
              <th>Zone</th>
              <th>Department</th>
              <th>Time Elapsed</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          `;
          table.appendChild(thead);
          
          // Create table body
          const tbody = document.createElement("tbody");
          
          snapshot.forEach(doc => {
            const complaint = doc.data();
            const tr = document.createElement("tr");
            tr.id = "complaint-" + doc.id;
            
            // Calculate time elapsed
            const createdAt = complaint.createdAt ? complaint.createdAt.toDate() : new Date();
            const now = new Date();
            const diffMs = now - createdAt;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            
            // Determine status class
            let statusClass = "pending";
            if (complaint.status === "Resolved") statusClass = "resolved";
            else if (complaint.status === "In Progress") statusClass = "in-progress";
            else if (complaint.status === "Escalated") statusClass = "escalated";
            
            tr.innerHTML = `
              <td>${complaint.title || "N/A"}</td>
              <td>${complaint.category || "N/A"}</td>
              <td>${complaint.zone || "N/A"}</td>
              <td>${complaint.department || "N/A"}</td>
              <td>${diffHrs} hrs</td>
              <td><span class="status ${statusClass}">${complaint.status || "Pending"}</span></td>
              <td>
                <button class="btn-escalate" data-id="${doc.id}">Reassign</button>
                <button class="btn-delete" data-id="${doc.id}">Delete</button>
              </td>
            `;
            tbody.appendChild(tr);
            
            // Attach event listener for reassign
            const reassignBtn = tr.querySelector(".btn-escalate");
            reassignBtn.addEventListener("click", async () => {
              const newDepartment = prompt("Enter new department for reassignment:");
              if (newDepartment) {
                await db.collection("complaints").doc(doc.id).update({ 
                  department: newDepartment,
                  status: "Reassigned",
                  reassignedAt: new Date()
                });
                alert("Complaint reassigned to " + newDepartment);
              }
            });
            
            // Attach event listener for delete
            const deleteBtn = tr.querySelector(".btn-delete");
            deleteBtn.addEventListener("click", async () => {
              if (confirm("Are you sure you want to delete this complaint?")) {
                await db.collection("complaints").doc(doc.id).delete();
                document.getElementById("complaint-" + doc.id).remove();
                alert("Complaint deleted successfully!");
              }
            });
          });
          
          table.appendChild(tbody);
          complaintsList.appendChild(table);
        });
    }

    // Check for complaints that need escalation (2+ minutes old for testing)
function checkForEscalations() {
  const twoMinutesAgo = new Date();
  twoMinutesAgo.setMinutes(twoMinutesAgo.getMinutes() - 2);
  
  db.collection("complaints")
    .where("createdAt", "<", twoMinutesAgo)
    .where("status", "in", ["Pending", "In Progress"])
    .get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        // Auto-escalate these complaints
        db.collection("complaints").doc(doc.id).update({
          status: "Escalated",
          escalatedAt: new Date()
        });
      });
      
      if (snapshot.size > 0) {
        console.log('Auto-escalated ${snapshot.size} complaints older than 2 minutes');
      }
    });
}

    // Load KPI data
    function loadKPIs() {
      // Get today's date at midnight
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      db.collection("complaints")
        .where("createdAt", ">", today)
        .get()
        .then(snapshot => {
          let resolvedCount = 0;
          let escalatedCountValue = 0;
          const wards = new Set();
          let totalResponseTime = 0;
          let resolvedWithTime = 0;
          
          snapshot.forEach(doc => {
            const complaint = doc.data();
            if (complaint.status === "Resolved") resolvedCount++;
            if (complaint.status === "Escalated") escalatedCountValue++;
            if (complaint.zone) wards.add(complaint.zone);
            
            // Calculate response time for resolved complaints
            if (complaint.status === "Resolved" && complaint.resolvedAt && complaint.createdAt) {
              const createdAt = complaint.createdAt.toDate();
              const resolvedAt = complaint.resolvedAt.toDate();
              const responseTime = (resolvedAt - createdAt) / (1000 * 60 * 60); // in hours
              totalResponseTime += responseTime;
              resolvedWithTime++;
            }
          });
          
          resolvedToday.textContent = resolvedCount;
          escalatedCount.textContent = escalatedCountValue;
          activeWards.textContent = wards.size;
          
          // Calculate average response time
          const avgTime = resolvedWithTime > 0 ? (totalResponseTime / resolvedWithTime).toFixed(1) : 0;
          avgResponseTime.textContent = '${avgTime} hrs';
        });
    }

    // Logout
    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    });

    // Chart.js Logic
    const deptCtx = document.getElementById("deptChart");
    new Chart(deptCtx, {
      type: "bar",
      data: {
        labels: ["Sanitation", "Electrical", "Water", "Fire", "Roads"],
        datasets: [{
          label: "Complaints",
          data: [25, 15, 10, 8, 12],
          backgroundColor: ["#3b82f6", "#f59e0b", "#10b981", "#ef4444", "#8b5cf6"]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });

    const priorityCtx = document.getElementById("priorityChart");
    new Chart(priorityCtx, {
      type: "pie",
      data: {
        labels: ["Resolved", "Pending", "Escalated"],
        datasets: [{
          data: [65, 20, 15],
          backgroundColor: ["#10b981", "#facc15", "#ef4444"]
        }]
      },
      options: { responsive: true }
    });
  </script>
</body>
</html>