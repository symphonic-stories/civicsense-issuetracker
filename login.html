<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login / Register - CivicSense</title>
  <link rel="stylesheet" href="css/login.css" />
  <link rel="icon" type="image/png" href="images/favicon.png">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <!-- ðŸŒ Glassmorphic Navbar -->
  <header>
    <nav class="navbar">
      <div class="logo">
        <img src="images/logocivic.png" alt="CivicSense Logo" />
      </div>
      
      <a href="index.html" class="btn-login">Home</a>
    </nav>
  </header>

  <!-- âœ… Login/Register Container -->
  <div class="login-container">
    <div class="container">
      <h2 id="form-title">Login</h2>
      <div class="input-group">
        <input type="email" id="email" placeholder="Email" />
      </div>
      <div class="input-group">
        <input type="password" id="password" placeholder="Password" />
      </div>
      <button id="submit-btn">Login</button>
      <button id="google-btn">Sign in with Google</button>
      <div class="toggle" id="toggle-form">Don't have an account? Register</div>
    </div>
  </div>

  <!-- âœ… Firebase Authentication Logic -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA5mUr6bSmy6Yh9kyD1K1IDC6BNRVI-U6o",
      authDomain: "civicissuetrackerapp.firebaseapp.com",
      projectId: "civicissuetrackerapp",
      storageBucket: "civicissuetrackerapp.appspot.com",
      messagingSenderId: "52255435185",
      appId: "1:52255435185:web:68cfef81c27b42ae71b590"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_UID = "OfHleQwQjgMRXTgroiAxJCJu5Sd2";
    let isLogin = true;

    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const toggleForm = document.getElementById('toggle-form');
    const googleBtn = document.getElementById('google-btn');

    toggleForm.addEventListener('click', () => {
      isLogin = !isLogin;
      formTitle.innerText = isLogin ? "Login" : "Register";
      submitBtn.innerText = isLogin ? "Login" : "Register";
      toggleForm.innerText = isLogin
        ? "Don't have an account? Register"
        : "Already have an account? Login";
    });

    submitBtn.addEventListener('click', () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (isLogin) {
        auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => handleUser(userCredential.user))
          .catch(error => alert(error.message));
      } else {
        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const uid = userCredential.user.uid;
            const role = (uid === ADMIN_UID) ? 'admin' : 'citizen';
            db.collection('users').doc(uid).set({ role })
              .then(() => handleUser(userCredential.user));
          })
          .catch(error => alert(error.message));
      }
    });

    googleBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          const uid = user.uid;
          const role = (uid === ADMIN_UID) ? 'admin' : 'citizen';
          db.collection('users').doc(uid).get().then(doc => {
            if (!doc.exists) db.collection('users').doc(uid).set({ role });
          }).finally(() => redirectUser(user));
        })
        .catch(error => alert(error.message));
    });

    function handleUser(user) {
      redirectUser(user);
    }

    function redirectUser(user) {
      const uid = user.uid;
      db.collection('users').doc(uid).get().then(doc => {
        let role = 'citizen';
        if (doc.exists) role = doc.data().role;
        if (uid === ADMIN_UID || role === 'admin') {
          window.location.href = 'admin-dashboard.html';
        } else {
          window.location.href = 'citizen-dashboard.html';
        }
      });
    }

    // Navbar scroll animation
    window.addEventListener('scroll', () => {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 10) navbar.classList.add('scrolled');
      else navbar.classList.remove('scrolled');
    });
  </script>
</body>
</html>

